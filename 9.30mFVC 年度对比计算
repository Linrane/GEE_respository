//加载研究区域：使用您导入的通辽范围数据
var tongliao = ee.FeatureCollection("projects/ee-linrane111/assets/tongliao")
  .geometry(); // 提取几何边界

//中心定位到通辽
Map.centerObject(tongliao, 8);
Map.addLayer(tongliao, {color: 'red'}, '通辽市边界');

//定义时间范围（生长季：6-8月，植被覆盖稳定期）
var year2015 = ee.DateRange('2015-06-01', '2015-08-31');
var year2025 = ee.DateRange('2025-06-01', '2025-08-31');

// Landsat 8去云函数（修正波段命名）
function maskL8Clouds(image) {
  var qa = image.select('QA_PIXEL');
  //云掩码（bit 3: 云，bit 4: 卷云）
  var cloudMask = qa.bitwiseAnd(1 << 3).eq(0)
                  .and(qa.bitwiseAnd(1 << 4).eq(0));
  //应用掩码并保留必要波段，添加NDVI（修正为SR_B4、SR_B5）
  return image.updateMask(cloudMask)
              .select(['SR_B2', 'SR_B3', 'SR_B4', 'SR_B5', 'SR_B6', 'SR_B7']) //修正波段选择
              .divide(10000) //反射率归一化
              .addBands(image.normalizedDifference(['SR_B5', 'SR_B4']).rename('NDVI')); //修正NDVI波段
}

//影像集预处理函数
function processYear(dateRange) {
  //加载Landsat 8 SR数据（已大气校正）
  var l8 = ee.ImageCollection('LANDSAT/LC08/C02/T1_L2')
    .filterBounds(tongliao)
    .filterDate(dateRange)
    .map(maskL8Clouds)
    .select('NDVI'); // 仅保留NDVI波段
  
  //最大值合成（MVC）减少云影影响
  var ndviMax = l8.max()
    .clip(tongliao)
    .rename('NDVI_max');
  
  //计算NDVI的5%（裸土参考）和95%（全植被参考）分位数
  var stats = ndviMax.reduceRegion({
    reducer: ee.Reducer.percentile([5, 95]),
    geometry: tongliao,
    scale: 30,
    maxPixels: 1e13
  });
  
  var ndviMin = ee.Number(stats.get('NDVI_max_p5'));
  var ndviMaxVeg = ee.Number(stats.get('NDVI_max_p95'));
  
  //像元二分模型计算FVC
  var fvc = ndviMax.subtract(ndviMin)
    .divide(ndviMaxVeg.subtract(ndviMin))
    .clamp(0, 1) // 限制范围0-1（避免异常值）
    .rename('FVC');
  
  return {
    ndvi: ndviMax,
    fvc: fvc
  };
}

//分别处理2015年和2025年数据
var result2015 = processYear(year2015);
var result2025 = processYear(year2025);

//可视化参数
var ndviVis = {min: -0.2, max: 0.8, palette: ['blue', 'white', 'green']};
var fvcVis = {min: 0, max: 1, palette: ['#f7fbff', '#abd0e6', '#3787c0', '#0d4b87']};

//添加图层到地图
Map.addLayer(result2015.ndvi, ndviVis, '2015年NDVI');
Map.addLayer(result2015.fvc, fvcVis, '2015年FVC');
Map.addLayer(result2025.ndvi, ndviVis, '2025年NDVI');
Map.addLayer(result2025.fvc, fvcVis, '2025年FVC');

//导出FVC结果到Drive（可选）
Export.image.toDrive({
  image: result2015.fvc,
  description: 'Tongliao_FVC_2015',
  folder: 'GEE_Results',
  region: tongliao,
  scale: 30,
  crs: 'EPSG:4326',
  maxPixels: 1e13
});

Export.image.toDrive({
  image: result2025.fvc,
  description: 'Tongliao_FVC_2025',
  folder: 'GEE_Results',
  region: tongliao,
  scale: 30,
  crs: 'EPSG:4326',
  maxPixels: 1e13
});
